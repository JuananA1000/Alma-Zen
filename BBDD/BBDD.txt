-- Creamos la base de datos
CREATE SCHEMA `almazen` ;

-- Creamos las tablas:
-- En primer lugar, de usuarios:
CREATE TABLE `almazen`.`usuarios` (
  `id_user` INT NOT NULL AUTO_INCREMENT,
  `user` VARCHAR(45) NOT NULL,
  `password` VARCHAR(45) NULL,
  `rol` VARCHAR(45) NULL,
  PRIMARY KEY (`id_user`));

-- Empresas:
CREATE TABLE `almazen`.`empresas` (
  `id_empresa` int(11) NOT NULL AUTO_INCREMENT,
  `nombre_empresa` varchar(45) NOT NULL,
  PRIMARY KEY (`id_empresa`)
);

-- Empleados:
CREATE TABLE `almazen`.`empleados` (
  `id_empleado` int(11) NOT NULL AUTO_INCREMENT,
  `nombre_empleado` varchar(45) NOT NULL,
  `apellidos_empleado` varchar(45) NOT NULL,
  `id_empresa` int(11) NOT NULL,
  PRIMARY KEY (`id_empleado`),
  KEY `fk_empleados_empresas_idempresa` (`id_empresa`),
  CONSTRAINT `fk_empleados_empresas_idempresa` FOREIGN KEY (`id_empresa`)
  REFERENCES `empresas` (`id_empresa`)
  ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- Útiles de la empresa:
CREATE TABLE `almazen`.`utiles` (
  `id_util` int(11) NOT NULL AUTO_INCREMENT,
  `id_empresa` int(11) NOT NULL,
  `marca_util` varchar(45) NOT NULL,
  `modelo_util` varchar(45) NOT NULL,
  `categoria_util` varchar(45) NOT NULL,
  `estado_util` varchar(100) DEFAULT NULL,
  `herramienta_vehiculo` varchar(45) NOT NULL,
  PRIMARY KEY (`id_util`),
  KEY `fk_utiles_empresas_idempresa` (`id_empresa`),
  CONSTRAINT `fk_utiles_empresa`
  FOREIGN KEY (`id_empresa`)
  REFERENCES `empresas` (`id_empresa`)
  ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- Y por último, la relación que recogerá el historial de las herramientas
-- adquiridas por cada empleado:
CREATE TABLE `almazen`.`emple_util` (
  `id_emple_util` int(11) NOT NULL AUTO_INCREMENT,
  `id_empleado` int(11) NOT NULL,
  `id_util` int(11) NOT NULL,
  `fecha_hora` datetime NOT NULL,
  `is_devuelto` bit(1) NOT NULL,
  `incidencia` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`id_emple_util`),
  KEY `fk_empleherra_empleados_id` (`id_empleado`),
  KEY `fk_empleherra_utiles_id` (`id_util`),
  CONSTRAINT `fk_empleherra_empleados`
  FOREIGN KEY (`id_empleado`)
  REFERENCES `empleados` (`id_empleado`)
  ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fk_empleherra_utiles`
  FOREIGN KEY (`id_util`)
  REFERENCES `utiles` (`id_util`)
  ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- A continuación, insertamos  datos a cada una de las tablas:
INSERT INTO almazen.usuarios (user, password, rol)
VALUES
    ('admin', 'admin', 'admin'),
    ('empleado', 'empleado', 'empleado');

INSERT INTO almazen.empresas (nombre_empresa)
VALUES
    ('Empresa A'),
	  ('Empresa B'),
    ('Empresa c');

INSERT INTO almazen.empleados (nombre_empleado, apellidos_empleado) VALUES ('Carlos','Castro');

INSERT INTO almazen.utiles (idempresa, Marca, Modelo, Categoria, Estado, Herramienta_Vehiculo)
VALUES
    ('8', 'Hilti','TE-60','Pistolete','','Herramienta'),
	('8', 'Hilti','TE-100','Rompedor','','Herramienta'),
    ('9', 'Caterpillar','Retro-MAX','Retroexcavadora','','Vehiculo'),
    ('10', 'Bosch','GWS 20-230','Radial','','Herramienta');